%html{:lang => "en"}
  %head
!!!
%html
  %head
    %meta{:charset => "utf-8"}/
    %title Login
    %meta{:charset => "utf-8"}/
    %meta{:content => "width=device-width, initial-scale=1, shrink-to-fit=no", :name => "viewport"}/
    %link{:href => "https://fonts.googleapis.com/css?family=Lato:300,400,700&display=swap", :rel => "stylesheet"}/
    = javascript_pack_tag "ecf_preview"
  %body-1
    %section.ftco-section


      .container.animate__animated.animate__fadeIn
        .row.justify-content-center
          .col-md-6.text-center.mb-5
            %h2.heading-section Listing ECFs

            
        .row.justify-content-center
          .ecf-preview
            .row
              .col
                %p.txt-centre#col1
                  
                  There #{@ecfs.size == 1 ? 'is' : 'are'} 
                  %span#num1 #{pluralize @ecfs.size, 'ecf'}
                - if current_user.role == "admin"
                  %p.txt-centre
                    = link_to "ECFs which need attention as per the GDPR Policy", ecfs_gdpr_ecfs_path
                  
            - if can? :create, Ecf
              .row.justify-content-center.mb-5
                .col-md-6.text-center
                  %br
                  %a.button.btn.btn-outline-primary.btn-sm{:href => new_ecfs_path} Create New ECF

            - if can? :search, Ecf
              .table-responsive
                %table.table.table-sm.table-bordered.mb-4
                  %thead.thead-light
                    = search_form_for @q do |f|
                      %tr
                        %th{:scope => "col"}= f.label "Ecf status"
                        %th{:scope => "col"}= f.label "First / Last name"
                        %th{:scope => "col"}= f.label "Student Email"
                        %th{:scope => "col"}

                      %tbody
                        = search_form_for @q do |f|
                          %tr
                            %th= f.search_field :status_cont
                            %td= f.search_field :user_givenname_or_user_sn_cont
                            %td= f.search_field :user_email_cont
                            %td= f.submit "Search"

            .table-responsive
              %table.table
              -if @ecfs.empty?
                %p.alert.alert-primary No result found! Please check your search criteria.
              -else
                .table-responsive
                  %table.table
                    %thead
                      %tr
                        %th{:scope => "col"} Status
                        %th{:scope => "col"} Date Submitted
                        %th{:scope => "col"} Student Full Name
                        %th{:scope => "col"} Student Email
                        %th{:scope => "col"} Student Username
                        %th{:scope => "col"} Student Department
                    %tbody
                      - @ecfs.each do |ecf|
                        %tr
                          %td= ecf.status
                          %td= ecf.date
                          %td #{ecf.user.givenname} #{ecf.user.sn}
                          %td= ecf.user.mail
                          %td= ecf.user.uid
                          %td= ecf.user.ou
                          %td= link_to 'Show', ecf
                          - if can? :edit, Ecf  
                            -if current_user.student?
                              -if ecf.decisions.size == 0
                                %td= link_to 'Edit', edit_ecf_path(ecf)
                              -else
                                %td Decisons have been made. Cannot edit ECF.
                            -else
                              %td= link_to 'Edit', edit_ecf_path(ecf)
                          - if(params.has_key?(:meeting_id))
                            %td= link_to "Add to meeting ##{params[:meeting_title]}", agendas_path(:agenda => {:ecf_id => ecf.id, :meeting_id => params[:meeting_id]}), :method => :post


